import os
import re
import warnings
import pandas as pd

path = "./testset/257ers - Holz/257ers - Holz.txt"
path = "./testset/Panic! At The Disco - High Hopes/Panic! At The Disco - High Hopes.txt"
path = "./testset/Culcha Candela - Ey DJ/Culcha Candela - Ey DJ.txt"

candidates = os.listdir("./testset")
dfs = []

_columns = ['Artist', 'Title', 'Directory', 'Cover', 'Video']
_dtypes = {'Artist': str, 'Title': str, 'Directory': str,
           'Cover': bool, 'Video': bool}

for candidate in candidates:
    try:
        files = os.listdir(path / candidate)
        # Extract Artist and Title information from .txt file
        r = re.compile(r".*\.txt$")
        newlist = list(filter(r.match, files))
        if len(newlist) > 1:
            raise FileNotFoundError("There are multiple .txt files in the" +
                                    f"subfolder {candidate}")
        txtfile = newlist[0]
        # ignore encoding errors that might appear in the lyrics section
        with open(path / candidate / txtfile, "r", errors="ignore") as f:
            data = "".join(f.readlines())
        artist = re.search(r"(?<=#ARTIST:).*?(?=\n)", data).group(0)
        title = re.search(r"(?<=#TITLE:).*?(?=\n)", data).group(0)
        # Check if video is available
        cover = any([re.search(r"(.*\.jpg)|(.*\.png)", file) for file in files])
        video = any([re.search(r"(.*\.mp4)|(.*\.avi)", file) for file in files])

        dfs.append(pd.DataFrame([dict(zip(_columns, [artist, title, candidate, cover,
                                                     video]))]))
    except Exception as e:
        warnings.warn(f"{candidate} had wrong format and was skipped.")
        print(e)
df = pd.concat(dfs, ignore_index=True)

for column in df.columns:
    df[column] = df[column].astype(_dtypes.get(column, bool))


df.sort_values(by=["Artist", "Title"], inplace=True)
